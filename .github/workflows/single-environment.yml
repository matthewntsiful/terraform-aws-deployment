name: 'Terraform Simple Deploy'

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'apply'
        type: choice
        options: [apply, destroy]

env:
  TF_VERSION: 1.6.6
  AWS_REGION: us-east-2
  WORKING_DIR: 'infra'

permissions:
  contents: read
  id-token: write
  pull-requests: write

jobs:
  terraform:
    name: 'Terraform (${{ github.event.inputs.action || (github.event_name == ''push'' && ''apply'' || ''plan'') }})'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIR }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up SSH for Private Modules
        if: vars.USES_PRIVATE_MODULES == 'true'
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Configure Git for SSH
        if: vars.USES_PRIVATE_MODULES == 'true'
        run: |
          git config --global url."git@github.com:".insteadOf "https://github.com/"
          mkdir -p ~/.ssh
          ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Terraform Format Check
        run: terraform fmt -check -recursive

      - name: Terraform Init
        run: terraform init

      - name: Terraform Validate
        run: terraform validate

      - name: Terraform Plan
        id: plan
        run: |
          # Determine plan action
          if [[ "${{ github.event.inputs.action }}" == "destroy" ]]; then
            terraform plan -destroy -input=false -out=tfplan
            echo "action=destroy" >> $GITHUB_OUTPUT
          else
            terraform plan -input=false -out=tfplan
            echo "action=apply" >> $GITHUB_OUTPUT
          fi
          
          # Generate human-readable plan
          terraform show -no-color tfplan > plan.txt
        continue-on-error: true

      - name: Update PR with Plan
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            try {
              const plan = fs.readFileSync('${{ env.WORKING_DIR }}/plan.txt', 'utf8');
              const action = '${{ steps.plan.outputs.action }}';
              const maxLength = 65536;
              
              let body = `## üèóÔ∏è Terraform Plan ${action === 'destroy' ? '(DESTROY)' : ''}\n\n`;
              
              if (plan.includes('No changes')) {
                body += '‚úÖ **No infrastructure changes detected**\n\n';
              } else if (plan.includes('Error') || '${{ steps.plan.outcome }}' === 'failure') {
                body += '‚ùå **Plan failed** - please check the workflow logs\n\n';
              } else {
                const emoji = action === 'destroy' ? 'üí•' : 'üìã';
                body += `${emoji} **Changes detected** - review the plan below:\n\n`;
              }
              
              body += '<details><summary>Show Plan</summary>\n\n```hcl\n' + plan + '\n```\n\n</details>';
              
              if (body.length > maxLength) {
                body = body.substring(0, maxLength - 100) + '\n\n... ‚úÇÔ∏è Plan output truncated';
              }
              
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            } catch (error) {
              console.error('Error reading plan file:', error);
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## ‚ùå Terraform Plan Failed\n\nUnable to generate plan. Check the workflow logs for details.`
              });
            }

      - name: Check Plan Status
        if: steps.plan.outcome == 'failure'
        run: |
          echo "‚ùå Terraform plan failed"
          exit 1

      - name: Terraform Apply/Destroy
        if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
        run: |
          if [[ "${{ steps.plan.outputs.action }}" == "destroy" ]]; then
            echo "üóëÔ∏è Destroying infrastructure..."
            terraform apply -auto-approve tfplan
          else
            echo "üöÄ Applying infrastructure changes..."
            terraform apply -auto-approve tfplan
          fi

      - name: Get Terraform Outputs
        if: (github.event_name == 'push' || github.event_name == 'workflow_dispatch') && steps.plan.outputs.action != 'destroy'
        id: outputs
        run: |
          # Get all outputs and save to file
          terraform output -json > outputs.json
          
          # Extract common outputs if they exist
          for output in application_url load_balancer_dns database_endpoint; do
            if terraform output $output >/dev/null 2>&1; then
              value=$(terraform output -raw $output)
              echo "${output}=${value}" >> $GITHUB_OUTPUT
              echo "üìã ${output}: ${value}"
            fi
          done
        continue-on-error: true

      - name: Upload Terraform Outputs
        if: (github.event_name == 'push' || github.event_name == 'workflow_dispatch') && steps.plan.outputs.action != 'destroy'
        uses: actions/upload-artifact@v4
        with:
          name: terraform-outputs
          path: ${{ env.WORKING_DIR }}/outputs.json
          retention-days: 30

      - name: Verify State
        if: always()
        run: |
          echo "üîç Current Terraform state:"
          terraform state list || echo "No resources in state"
        continue-on-error: true

      - name: Comment Deployment Result
        if: github.event_name == 'pull_request' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
        uses: actions/github-script@v7
        with:
          script: |
            const action = '${{ steps.plan.outputs.action }}';
            const success = '${{ job.status }}' === 'success';
            
            let body = '';
            if (action === 'destroy') {
              body = success 
                ? `## üí• Infrastructure Destroyed Successfully\n\nüïí **Destroyed at:** ${new Date().toISOString()}\nüìù **Commit:** ${context.sha.substring(0, 7)}`
                : `## ‚ùå Infrastructure Destruction Failed\n\nCheck the workflow logs for details.`;
            } else {
              if (success) {
                body = `## ‚úÖ Deployment Successful\n\n`;
                const outputs = [
                  '${{ steps.outputs.outputs.application_url }}',
                  '${{ steps.outputs.outputs.load_balancer_dns }}',
                  '${{ steps.outputs.outputs.database_endpoint }}'
                ].filter(Boolean);
                
                if (outputs.length > 0) {
                  body += `### üîó Outputs:\n${outputs.map(url => `- ${url}`).join('\n')}\n\n`;
                }
                
                body += `üïí **Deployed at:** ${new Date().toISOString()}\nüìù **Commit:** ${context.sha.substring(0, 7)}`;
              } else {
                body = `## ‚ùå Deployment Failed\n\nCheck the workflow logs for details.`;
              }
            }
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  notify:
    name: 'Slack Notification'
    needs: terraform
    if: always() && vars.SLACK_NOTIFICATIONS == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Determine Status
        id: status
        run: |
          if [[ "${{ needs.terraform.result }}" == "success" ]]; then
            echo "status=‚úÖ Succeeded" >> $GITHUB_OUTPUT
            echo "color=good" >> $GITHUB_OUTPUT
          elif [[ "${{ needs.terraform.result }}" == "failure" ]]; then
            echo "status=‚ùå Failed" >> $GITHUB_OUTPUT
            echo "color=danger" >> $GITHUB_OUTPUT
          else
            echo "status=‚ö†Ô∏è Cancelled" >> $GITHUB_OUTPUT
            echo "color=warning" >> $GITHUB_OUTPUT
          fi

      - name: Send Slack Notification
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "attachments": [
                {
                  "color": "${{ steps.status.outputs.color }}",
                  "blocks": [
                    {
                      "type": "section",
                      "text": {
                        "type": "mrkdwn",
                        "text": "*Terraform Deployment* üöÄ"
                      }
                    },
                    {
                      "type": "section",
                      "fields": [
                        {
                          "type": "mrkdwn",
                          "text": "*Repository:*\n${{ github.repository }}"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Branch:*\n${{ github.ref_name }}"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Action:*\n${{ github.event.inputs.action || (github.event_name == 'push' && 'apply' || 'plan') }}"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Status:*\n${{ steps.status.outputs.status }}"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Commit:*\n<https://github.com/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha }}>"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Triggered by:*\n${{ github.actor }}"
                        }
                      ]
                    },
                    {
                      "type": "actions",
                      "elements": [
                        {
                          "type": "button",
                          "text": {
                            "type": "plain_text",
                            "text": "View Workflow Run",
                            "emoji": true
                          },
                          "url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK